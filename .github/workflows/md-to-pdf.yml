name: Build Markdown PDF

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc, LaTeX, and CJK fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-latex-base texlive-fonts-recommended texlive-latex-extra texlive-xetex \
            fonts-noto-cjk

      - name: Normalize image paths for Linux
        run: |
          python3 - <<'PY'
          import re
          p = "SmartPatrolUserManual.md"
          s = open(p, "r", encoding="utf-8").read()

          # 1) Markdown image/link: ](.\xxx) or ](.\\xxx) -> ](./xxx)
          s = re.sub(r'\]\(\s*\.\\\\', '](./', s)
          s = re.sub(r'\]\(\s*\./\./', '](./', s)

          # 2) HTML img: src=".\xxx" or src='.\\xxx' -> src="./xxx"
          s = re.sub(r'src=(["\'])\.\\\\', r'src=\1./', s)

          # 3) General: ".\image.png" standalone (last resort, but limited)
          s = s.replace(".\\image", "./image")

          open("SmartPatrolUserManual.pandoc.md", "w", encoding="utf-8").write(s)
          PY

      - name: Build PDF from Markdown
        run: |
          mkdir -p dist
          pandoc SmartPatrolUserManual.pandoc.md \
            -o dist/SmartPatrol-User-Manual.pdf \
            --from markdown-yaml_metadata_block+raw_tex+link_attributes+pipe_tables \
            --pdf-engine=xelatex \
            --resource-path=.:docs:docs/images:images \
            --metadata-file=metadata.yaml \
            --toc \
            --number-sections \
            -V mainfont="Noto Sans CJK TC" \
            -V geometry:margin=2cm \
            -V fontsize=10pt \
            --wrap=preserve

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: smartpatrol-user-manual-pdf
          path: dist/SmartPatrol-User-Manual.pdf
